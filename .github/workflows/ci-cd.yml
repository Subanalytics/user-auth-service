# The 'test' job stays the same as before...

# This job builds, pushes the image, and updates the central Helm chart
build_and_update_chart:
  runs-on: ubuntu-latest
  needs: test # Depends on the test job succeeding

  steps:
    - name: Checkout service repo code
      uses: actions/checkout@v4

    # ... (Add your Docker login, build, and push steps here as before) ...
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

    # --- New GitOps Steps ---
    - name: Clone the infra repository
      uses: actions/checkout@v4
      with:
        repository: subanalytics/infra-and-cicd
        path: infra-and-cicd
        token: ${{ secrets.GH_PAT }} # Use PAT to get push access

    - name: Update image tag in values.yaml
      run: |
        # Install yq, a tool for editing YAML files
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq
        # Use yq to update the tag for the correct service
        yq e -i '.${{ env.SERVICE_NAME }}.image.tag = "${{ github.sha }}"' infra-and-cicd/values.yaml
      env:
        SERVICE_NAME: userAuthService # Must match the key in values.yaml

    - name: Commit and push the updated values.yaml
      run: |
        cd infra-and-cicd
        git config user.name "GitHub Actions Bot"
        git config user.email "<>"
        git add values.yaml
        # Commit only if there are changes
        if ! git diff --staged --quiet; then
          git commit -m "ci: Update image tag for ${{ env.SERVICE_NAME }} to ${{ github.sha }}"
          git push
        else
          echo "No changes to commit."
        fi
